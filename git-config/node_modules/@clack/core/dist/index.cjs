"use strict";const sisteransi=require("sisteransi"),node_process=require("node:process"),readline=require("node:readline"),node_tty=require("node:tty"),color=require("picocolors");function _interopNamespaceDefault(r){const t=Object.create(null);if(r)for(const s in r)t[s]=r[s];return t.default=r,t}const readline__namespace=_interopNamespaceDefault(readline);function diffLines(r,t){if(r===t)return;const s=r.split(`
`),e=t.split(`
`),i=[];for(let o=0;o<Math.max(s.length,e.length);o++)s[o]!==e[o]&&i.push(o);return i}const cancel=Symbol("clack:cancel");function isCancel(r){return r===cancel}function setRawMode(r,t){r.isTTY&&r.setRawMode(t)}const aliases=new Map([["k","up"],["j","down"],["h","left"],["l","right"]]),keys=new Set(["up","down","left","right","space","enter"]);class Prompt{constructor({render:t,input:s=node_process.stdin,output:e=node_process.stdout,...i},o=!0){this._track=!1,this._cursor=0,this.state="initial",this.error="",this.subscribers=new Map,this._prevFrame="",this.opts=i,this.onKeypress=this.onKeypress.bind(this),this.close=this.close.bind(this),this.render=this.render.bind(this),this._render=t.bind(this),this._track=o,this.input=s,this.output=e}prompt(){const t=new node_tty.WriteStream(0);return t._write=(s,e,i)=>{this._track&&(this.value=this.rl.line.replace(/\t/g,""),this._cursor=this.rl.cursor,this.emit("value",this.value)),i()},this.input.pipe(t),this.rl=readline.createInterface({input:this.input,output:t,tabSize:2,prompt:"",escapeCodeTimeout:50}),readline.emitKeypressEvents(this.input,this.rl),this.rl.prompt(),this.opts.initialValue!==void 0&&this._track&&this.rl.write(this.opts.initialValue),this.input.on("keypress",this.onKeypress),setRawMode(this.input,!0),this.render(),new Promise((s,e)=>{this.once("submit",()=>{this.output.write(sisteransi.cursor.show),setRawMode(this.input,!1),s(this.value)}),this.once("cancel",()=>{this.output.write(sisteransi.cursor.show),setRawMode(this.input,!1),s(cancel)})})}on(t,s){const e=this.subscribers.get(t)??[];e.push({cb:s}),this.subscribers.set(t,e)}once(t,s){const e=this.subscribers.get(t)??[];e.push({cb:s,once:!0}),this.subscribers.set(t,e)}emit(t,...s){const e=this.subscribers.get(t)??[],i=[];for(const o of e)o.cb(...s),o.once&&i.push(()=>e.splice(e.indexOf(o),1));for(const o of i)o()}unsubscribe(){this.subscribers.clear()}onKeypress(t,s){if(this.state==="error"&&(this.state="active"),s?.name&&!this._track&&aliases.has(s.name)&&this.emit("cursor",aliases.get(s.name)),s?.name&&keys.has(s.name)&&this.emit("cursor",s.name),t&&(t.toLowerCase()==="y"||t.toLowerCase()==="n")&&this.emit("confirm",t.toLowerCase()==="y"),t&&this.emit("key",t.toLowerCase()),s?.name==="return"){if(this.opts.validate){const e=this.opts.validate(this.value);e&&(this.error=e,this.state="error",this.rl.write(this.value))}this.state!=="error"&&(this.state="submit")}t===""&&(this.state="cancel"),(this.state==="submit"||this.state==="cancel")&&this.emit("finalize"),this.render(),(this.state==="submit"||this.state==="cancel")&&this.close()}close(){this.input.unpipe(),this.input.removeListener("keypress",this.onKeypress),this.output.write(`
`),setRawMode(this.input,!1),this.rl.close(),this.emit(`${this.state}`,this.value),this.unsubscribe()}restoreCursor(){const t=this._prevFrame.split(`
`).length-1;this.output.write(sisteransi.cursor.move(-999,t*-1))}render(){const t=this._render(this)??"";if(t!==this._prevFrame){if(this.state==="initial")this.output.write(sisteransi.cursor.hide);else{const s=diffLines(this._prevFrame,t);if(this.restoreCursor(),s&&s?.length===1){const e=s[0];this.output.write(sisteransi.cursor.move(0,e)),this.output.write(sisteransi.erase.lines(1));const i=t.split(`
`);this.output.write(i[e]),this._prevFrame=t,this.output.write(sisteransi.cursor.move(0,i.length-e-1));return}else if(s&&s?.length>1){const e=s[0];this.output.write(sisteransi.cursor.move(0,e)),this.output.write(sisteransi.erase.down());const o=t.split(`
`).slice(e);this.output.write(o.join(`
`)),this._prevFrame=t;return}this.output.write(sisteransi.erase.down())}this.output.write(t),this.state==="initial"&&(this.state="active"),this._prevFrame=t}}}class ConfirmPrompt extends Prompt{get cursor(){return this.value?0:1}get _value(){return this.cursor===0}constructor(t){super(t,!1),this.value=!!t.initialValue,this.on("value",()=>{this.value=this._value}),this.on("confirm",s=>{this.output.write(sisteransi.cursor.move(0,-1)),this.value=s,this.state="submit",this.close()}),this.on("cursor",()=>{this.value=!this.value})}}class GroupMultiSelectPrompt extends Prompt{constructor(t){super(t,!1),this.cursor=0;const{options:s}=t;this.options=Object.entries(s).flatMap(([e,i])=>[{value:e,group:!0,label:e},...i.map(o=>({...o,group:e}))]),this.value=[...t.initialValues??[]],this.cursor=Math.max(this.options.findIndex(({value:e})=>e===t.cursorAt),0),this.on("cursor",e=>{switch(e){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.toggleValue();break}})}getGroupItems(t){return this.options.filter(s=>s.group===t)}isGroupSelected(t){return this.getGroupItems(t).every(e=>this.value.includes(e.value))}toggleValue(){const t=this.options[this.cursor];if(t.group===!0){const s=t.value,e=this.getGroupItems(s);this.isGroupSelected(s)?this.value=this.value.filter(i=>e.findIndex(o=>o.value===i)===-1):this.value=[...this.value,...e.map(i=>i.value)],this.value=Array.from(new Set(this.value))}else{const s=this.value.includes(t.value);this.value=s?this.value.filter(e=>e!==t.value):[...this.value,t.value]}}}class MultiSelectPrompt extends Prompt{constructor(t){super(t,!1),this.cursor=0,this.options=t.options,this.value=[...t.initialValues??[]],this.cursor=Math.max(this.options.findIndex(({value:s})=>s===t.cursorAt),0),this.on("key",s=>{s==="a"&&this.toggleAll()}),this.on("cursor",s=>{switch(s){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break;case"space":this.toggleValue();break}})}get _value(){return this.options[this.cursor].value}toggleAll(){const t=this.value.length===this.options.length;this.value=t?[]:this.options.map(s=>s.value)}toggleValue(){const t=this.value.includes(this._value);this.value=t?this.value.filter(s=>s!==this._value):[...this.value,this._value]}}class PasswordPrompt extends Prompt{constructor({mask:t,...s}){super(s),this.valueWithCursor="",this._mask="\u2022",this._mask=t??"\u2022",this.on("finalize",()=>{this.valueWithCursor=this.masked}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.masked}${color.inverse(color.hidden("_"))}`;else{const e=this.masked.slice(0,this.cursor),i=this.masked.slice(this.cursor);this.valueWithCursor=`${e}${color.inverse(i[0])}${i.slice(1)}`}})}get cursor(){return this._cursor}get masked(){return this.value.replaceAll(/./g,this._mask)}}class SelectPrompt extends Prompt{constructor(t){super(t,!1),this.cursor=0,this.options=t.options,this.cursor=this.options.findIndex(({value:s})=>s===t.initialValue),this.cursor===-1&&(this.cursor=0),this.changeValue(),this.on("cursor",s=>{switch(s){case"left":case"up":this.cursor=this.cursor===0?this.options.length-1:this.cursor-1;break;case"down":case"right":this.cursor=this.cursor===this.options.length-1?0:this.cursor+1;break}this.changeValue()})}get _value(){return this.options[this.cursor]}changeValue(){this.value=this._value.value}}class SelectKeyPrompt extends Prompt{constructor(t){super(t,!1),this.cursor=0,this.options=t.options;const s=this.options.map(({value:[e]})=>e?.toLowerCase());this.cursor=Math.max(s.indexOf(t.initialValue),0),this.on("key",e=>{if(!s.includes(e))return;const i=this.options.find(({value:[o]})=>o?.toLowerCase()===e);i&&(this.value=i.value,this.state="submit",this.emit("submit"))})}}class TextPrompt extends Prompt{constructor(t){super(t),this.valueWithCursor="",this.on("finalize",()=>{this.value||(this.value=t.defaultValue),this.valueWithCursor=this.value}),this.on("value",()=>{if(this.cursor>=this.value.length)this.valueWithCursor=`${this.value}${color.inverse(color.hidden("_"))}`;else{const s=this.value.slice(0,this.cursor),e=this.value.slice(this.cursor);this.valueWithCursor=`${s}${color.inverse(e[0])}${e.slice(1)}`}})}get cursor(){return this._cursor}}function block({input:r=node_process.stdin,output:t=node_process.stdout,overwrite:s=!0,hideCursor:e=!0}={}){const i=readline__namespace.createInterface({input:r,output:t,prompt:"",tabSize:1});readline__namespace.emitKeypressEvents(r,i),r.isTTY&&r.setRawMode(!0);const o=(h,{name:u})=>{if(String(h)===""&&process.exit(0),!s)return;let n=u==="return"?0:-1,a=u==="return"?-1:0;readline__namespace.moveCursor(t,n,a,()=>{readline__namespace.clearLine(t,1,()=>{r.once("keypress",o)})})};return e&&process.stdout.write(sisteransi.cursor.hide),r.once("keypress",o),()=>{r.off("keypress",o),e&&process.stdout.write(sisteransi.cursor.show),i.terminal=!1,i.close()}}exports.ConfirmPrompt=ConfirmPrompt,exports.GroupMultiSelectPrompt=GroupMultiSelectPrompt,exports.MultiSelectPrompt=MultiSelectPrompt,exports.PasswordPrompt=PasswordPrompt,exports.Prompt=Prompt,exports.SelectKeyPrompt=SelectKeyPrompt,exports.SelectPrompt=SelectPrompt,exports.TextPrompt=TextPrompt,exports.block=block,exports.isCancel=isCancel;
